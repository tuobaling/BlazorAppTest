@inject HttpClient Http
@inject NavigationManager NavigationManager
@using System.Text.Json
@using BlazorAppTest.Client.Models.ViewModels;

<div class="card">
    <h5 class="card-header">@todoList.Title</h5>
    <div class="card-body">
        <div class="row">
            <div class="col-10">
                <input type="text" class="form-control" placeholder="Add a TodoItem" @bind="newItemText" />
            </div>
            <div class="col-2">
                <div class="float-right">
                    <button class="btn btn-primary" @onclick="(() => AddTaskName(todoList.ListId))">Add</button>
                </div>
            </div>
        </div>
        <hr />
        @foreach (var item in todoList.TodoItems)
        {
            <Todo TaskName="@item.TaskName" ItemIndex="@item.ItemId" Sort="@item.Sort" ParentId="@item.ListId" />
        }
    </div>

</div>


@code{
    [Parameter]
    public TodoList todoList { get; set; }

    private string newItemText;

    private async Task AddTaskName(int? listId)
    {
        // TODO:要加資料驗證
        int lastSort = await Http.GetFromJsonAsync<int>("/api/TodoList/GetLastSortByItem/?listId=" + listId);
        int newSort = lastSort + 1;

        var todoItem = new TodoItem()
        {
            ListId = (int)todoList.ListId,
            Sort = newSort,
            TaskName = newItemText,
            Completed = false
        };

        var jsonText = JsonSerializer.Serialize(todoItem);
        var response = await Http.PostAsJsonAsync<string>("api/TodoList/CreateTask", jsonText);

        if (response.IsSuccessStatusCode)
            NavigationManager.NavigateTo("/TodoList/Index", true);
        else
            Console.WriteLine(response.Content);
    }
}
